---
layout: post
title: K8S notes
date: 2017-07-13
tags: ["K8S", "PAAS"]
---

# 无选择器服务

使用场景：

- 通过SERVICE连接到外部服务
- 连接到另一个名字空间或集群
- 迁移过程中访问遗留系统

步骤

- 创建服务

```
kind: Service
apiVersion: v1
metadata:
  name: ext-db
spec:
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3316
```

- 手动创建一个端点

```
kind: Endpoints
apiVersion: v1
metadata:
  name: my-service
subsets:
  - addresses:
      - ip: 10.8.0.2
    ports:
      - port: 3316
```




# Creating sample user

* Create Service Account

`dashboard-adminuser.yaml`

```
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
```

* Create ClusterRoleBinding

asumming that cluster-admin exists(provisioned by kubeadmin or kops)

`adminuser-bind-clusteramdin.yaml`

```
apiVersion: rbac.authorization.K8S.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.K8S.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
```

```
kubectl apply -f dashboard-adminuser.yaml
```

* login with Bearer Token

```
kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')
```


# multi-tenant K8S clusters at network-level:

- Namespaces
- Ingress rules
- allow/deny and ingress/egress Network Policies
- Network-aware Zones

# Architect a multi-tenant system with kubernetes
I don't think there is one document out there really summaries everything. The link below is a bit old but can help outline some of the basics on how they build on K8S. Ultimately the primitives are the same but they abstract namespaces a bit and build it around RBAC. Coupled with a default vxlan (isolated) SDN plugin and their ingress routing, its a compelling multi-tenant solution that provides isolation and quotes at multiple levels.

Openshift really just adds some glue (a lot of it being devleoper workflow) on top of Kubernetes. What is nice is that RedHat continues to try and upstream features of origin into K8S where it makes sense.

https://blog.openshift.com/building-kubernetes-bringing-google-scale-container-orchestration-to-the-enterprise/
[https://www.reddit.com/r/kubernetes/comments/6qp24h/ask_kubernetes_how_would_you_architect_a/](https://www.reddit.com/r/kubernetes/comments/6qp24h/ask_kubernetes_how_would_you_architect_a/)
